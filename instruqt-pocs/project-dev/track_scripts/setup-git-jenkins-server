#!/bin/bash
set -euxo pipefail

echo "Running track setup script"

# Wait for the Instruqt host bootstrap to finish.
until [ -f /opt/instruqt/bootstrap/host-bootstrap-completed ]
do
    sleep 1
done

password=$HTTP_SECRET
# Configure Nginx
rm /etc/nginx/sites-enabled/default
nginx -s reload

####### Install Git 
sudo useradd -s /bin/bash -d /home/git/ -m -G sudo git
sudo mkdir /home/git/.ssh/
sudo chmod 0700 /home/git/.ssh/
KEY=$(cat ~/.ssh/id_rsa.pub)
echo "$KEY"
sudo -- sh -c "echo '$KEY' > /home/git/.ssh/authorized_keys"
sudo chown -R git:git /home/git/.ssh/
sudo mkdir /home/git/project.git
sudo chmod 0700 /home/git/project.git/
sudo -- sh -c "cd /home/git/project.git ; git init --bare"
sudo chown -R git:git  /home/git/project.git/

#######
sudo apt update
sudo apt install -y build-essential net-tools curl git software-properties-common nginx git fcgiwrap apache2-utils unzip
mkdir /var/www/html/myrepo  ; cd /var/www/html/myrepo ; mkdir project.git
cd project.git ; git --bare init
git update-server-info
chown -R www-data:www-data /var/www/html/myrepo ; chmod -R 755 /var/www/html/myrepo

echo "$password" | htpasswd -c -i  /var/www/html/myrepo/htpasswd gituser
cat >> /etc/nginx/conf.d/git-jenkins-server.${_SANDBOX_ID}.instruqt.io.conf <<-EOF
server {
   listen 80 default_server;
   listen [::]:80 default_server;
   root /var/www/html/myrepo;
   server_name git-jenkins-server.${_SANDBOX_ID}.instruqt.io;
   index index.html index.htm index.git-jenkins-server.dxuowdcjuw4e.instruqt.io.html;

   location / {
       try_files \$uri \$uri/ =404;
   }

   location ~ (/.*) {
       client_max_body_size 0;
       auth_basic "Git Login";
       auth_basic_user_file "/var/www/html/myrepo/htpasswd";
       include /etc/nginx/fastcgi_params;
       fastcgi_param SCRIPT_FILENAME /usr/lib/git-core/git-http-backend;
       fastcgi_param GIT_HTTP_EXPORT_ALL "";
       fastcgi_param GIT_PROJECT_ROOT /var/www/html/myrepo;
       fastcgi_param REMOTE_USER \$remote_user;
       fastcgi_param PATH_INFO \$1;
       fastcgi_pass unix:/var/run/fcgiwrap.socket;
   }
}
EOF

nginx -t
systemctl restart nginx 



